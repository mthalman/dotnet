<Project Sdk="Microsoft.Build.Traversal">

  <PropertyGroup>
    <ScenarioTestsArtifactsDir>$([MSBuild]::NormalizeDirectory('$(ArtifactsDir)', 'scenario-tests'))</ScenarioTestsArtifactsDir>
    <ScenarioTestsResultsDir>$([MSBuild]::NormalizeDirectory('$(ArtifactsTestResultsDir)', 'scenario-tests'))</ScenarioTestsResultsDir>
    <_ScenarioTestsNuGetConfig>$(ScenarioTestsArtifactsDir)NuGet.config</_ScenarioTestsNuGetConfig>
    <_InstallerNuGetConfig>$(RepoRoot)src/installer/NuGet.config</_InstallerNuGetConfig>
  </PropertyGroup>

  <ItemGroup>
    <ProjectReference Include="../src/scenario-tests/src/**/*.csproj" />
  </ItemGroup>

  <Target Name="SetupNuGetConfig"
          Inputs="$(_InstallerNuGetConfig)"
          Outputs="$(_ScenarioTestsNuGetConfig)">

    <Copy SourceFiles="$(_InstallerNuGetConfig)"
          DestinationFiles="$(_ScenarioTestsNuGetConfig)" />

  </Target>

  <Target Name="RunScenarioTests"
          DependsOnTargets="SetupNuGetConfig;DetermineSourceBuiltSdkVersion">
    
    <PropertyGroup>
      <_CurrentDateTime>$([System.DateTime]::Now.ToString("yyyy-MM-dd_HH_mm_ss"))</_CurrentDateTime>
      <_TestXmlOutputPath>$(ScenarioTestsResultsDir)$(_CurrentDateTime).xml</_TestXmlOutputPath>
      <_ScenarioTestsAdditionalArgs>--xml $(_TestXmlOutputPath) --target-rid $(TargetRid) --no-cleanup --no-traits Category=MultiTFM</_ScenarioTestsAdditionalArgs>

      <!-- Define the test root as a sub-directory of the scenario test artifacts directory. It needs to be a sub-directory because the scenario test execution
           will clean that directory. Since we need the NuGet.config file that we copied in to be preserved, that's stored in the directory above the test root. -->
      <_TestRoot>$(ScenarioTestsArtifactsDir)artifacts/</_TestRoot>
    </PropertyGroup>

    <MakeDir Directories="$(ScenarioTestsResultsDir)" />

    <ItemGroup>
      <_ScenarioTestProperties Include="
        Configuration=$(Configuration);
        RunScenarioTests=true;
        TestRoot=$(_TestRoot);
        DotNetRoot=$(DotNetSdkExtractDir);
        NETCoreSdkVersion=$(SourceBuiltSdkVersion);
        AdditionalTestArgs=$(_ScenarioTestsAdditionalArgs);
        DOTNET_INSTALL_DIR=$(DotNetRoot)" />
    </ItemGroup>

    <MSBuild Projects="$(MSBuildThisFileFullPath)"
             Properties="@(_ScenarioTestProperties)"
             Targets="Restore;Build;Test" />
  </Target>
</Project>
